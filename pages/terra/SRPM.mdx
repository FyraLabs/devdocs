The ---
name: SRPM Macros
description: Documentation on the macros included in the anda-srpm-macros package
---

We provide SPRM macros to ease packaging and better integrate into our workflow. Please use these macros when possible.

These are provided in the `anda-srpm-macros` package. If you use them, make sure to add `anda-srpm-macros` as a `BuildRequires:` in the spec file.

You may need to refer to the [miscellaneous packaging guidelines](./policy#miscellaneous-packaging-guidelines) for more details.

For other macros available in Fedora/Terra, check out our unofficial [macros list](../rpm/macros).

# Directories

## %__anda_develfiles

## %_anda_srpm_macros_dir
`/usr/libexec/anda-srpm-macros`.

## %__anda_staticfiles

## %__anda_libsfiles

## %elvish_completions_dir
`%_datadir/elvish/lib/completions`

## %rpmbuilddir
`%{?builddir}%{?!builddir:%{_builddir}}`.

# Electron

## %electronmeta
Set up all basic requirements including build macros for building an Electron app.

Rundown of what all `%electronmeta` does:
- Converts `%{_target_cpu}` (the RPM build architecture) into `%{_electron_cpu}`, the Electron format for architectures it is compatible with.
  - Defines `%{_electron_cpu}` for x86_64 architectures as `x64`.
  - Defines `%{_electron_cpu}` for aarch64 architectures as `arm64`.
  - Defines `%{_electron_cpu}` for x86 architectures as `ia32`.
  - Defines `%{_electron_cpu}` for armv7l architectures as `armv7l`.
    - These are defined because Electron names the build files and directories after the architecture
    - The macros used to build Electron apps (`%npm_build`, `%bun_build`, `%pnpm_build`, and `%yarn_build`) all require this to be set
    - In some cases, these architectures are used in the source tarballs for Electron projects
    - This can also be used to help work with the files if you need to do anything manually
- Defines `%__provides_excludes` to make sure Electron apps are not flagged as providers of their bundled dependencies, such as FFmpeg libraries.
- Defines `%__requires_excludes` based on architecture to prevent Electron Builder's cross-compilation from causing false dependency positives from RPM.
- Sets `%debug_package` to `%{nil}` to prevent stripping of bundled libraries and/or build failures due to not enough data to strip.
- Sets the build and runtime dependencies. The -a flag can be used to pull additional build dependencies that are sometimes needed when building through NPM in particular.
- Sets the `ExclusiveArch` field to only the architectures Electron supports.
- Defines the bundled dependencies as bundled. NOTE: This only defines Electron's bundled dependencies, not any Node modules the app may also bundle.

This ensures packagers do not need to manually set these for every Electron app's spec, hopefully eliminating depsolver problems and helping reduce common build issues.

## %electron_install
Install files built using Electron Builder.

By default, the install steps are:
1. Make the install directory
  - This will be in the `%{_libdir}` (/usr/lib on 32-bit architectures and /usr/lib64 on 64-bit ones)
  - This is done because programs with bundled dependencies (Electron, Node modules, and more) MUST have these dependencies kept together
1. Install the app's files
1. Symlink the app's binary to the bin directory
1. Install the app's icons

`%electron_install` supports several flags to help control variables of the install. Most of the fallbacks if none are passed are the name of the package.
- `-b` must be used when the app's executable differs from the name of the package.
- `-d` can be used to install the app under a different directory than the name of the package.
- `-i` must be used when the app's desktop file points to an icon name different from the name of the package.
- `-l` can be used to fetch all licenses including the bundled ones and put them in a directory in the `%{builddir}`. You can then put them in the license directory using `%license %{rpmbuilddir}/bundled_licenses/*` (for more information on `%{rpmbuilddir}` and why we have it, see [TBA])
- `-s` can be used to choose the name of the symlink.
- `-S` can be used to create an additional symlink with a different name. Useful when an app has two interchangeable common names.
- `-D` can be used to handle automatic installation of the .desktop file. This ONLY works if Electron Builder builds an AppImage, and should not be used if the source contains a desktop file.
- `-E` can be used to set the "--enable-features" flag in the desktop file. Features to enable must be comma separated without spaces.
- `-O` can be used to set the Ozone flatform the Electron app will run on. If no arguments are supplied, it will fall back to auto. Accepted arguments are `-Ox11` and `-Owayland`
- `-U` can be used to set either `%u` or `%U` in the desktop file. This REQUIRES you do not use `u` as a macro name for any reason.
  - `%u` means that a desktop file can only read one URL at a time, `%U` means that it can read multiple at a time.
  - Defer to what the desktop file originally contained if you are unsure.

Example:
- The command `%electron_install -b app -i app -s app -S alsoapp -D -Owayland -U %u -E WaylandWindowDecorations` would install the program with:
  - Icons named `app.png`
  - A symlink named `app`
  - A second symlink called `alsoapp`
  - A desktop file with the `Exec` line reading `Exec=/usr/lib(64)/pkgname/app --enable-features=WaylandWindowDecorations --ozone-platform=wayland %u`

## %electron_license
The license for bundled Electron. NOT set by default in `%electronmeta` because you cannot set the license field twice. MAY be used in combination with manually adding the other relevant licenses (if this is done, a proper license tag would be `License: XXX-x.x AND %electron_license`.

## %electron_arches
The architectures Electron supports. Automatically set as `ExclusiveArch` when using `%electronmeta`.

As written, the macro is:
- `%{x86_64} %{ix86} %{arm64} armv7l armv7hl armv7hnl`

Which expands fully to:
- `x86_64 x86_64_v2 x86_64_v3 x86_64_v4 amd64 em64t i386 i486 i586 i686 pentium3 pentium4 athlon geode aarch64 armv7l armv7hl armv7hnl`

Which simply means Electron supports x86_64, x86, aarch64/ARM64, and armv7l.

# Go

## %go_task
Should be used in place of `go-task`.

# JavaScript/JavaScript Package Managers

# Nim

# Rust

## %cargo_prep_online
Enables internet access for `cargo_prep`. Replaces `%cargo_prep` in `%prep`.

## %cargo_license_online
Enables internet access for `cargo_license`.
Replaces `%cargo_license` in `%build`.

## %cargo_license_summary_online
Enables internet access for `cargo_license_summary`.
Replaces `%cargo_license_summary` in `%build`.

## %cargo_vendor_manifest_online
Enables internet access for `cargo_vendor_manifest_online`. 
Replaces `%cargo_vendor_manifest` in `%build`. 

## %crate_install_bin
Used to install crates that build as single binary.
Can be used instead of `%cargo_install` when [this](https://github.com/terrapkg/packages/issues/1169) is applicable.

## %rustup_nightly
Used in `%prep` for nightly `rustc`/`cargo` from `rustup`.

# Subpackages

## %pkg_completion
Check [here](https://developer.fyralabs.com/terra/policy#shell-completions) for more details

## pkg_devel_files
Set the summary & description, then find development `%files`.

## %pkg_static_files
Set the summary & description, then find static libraries.

## %pkg_libs_files



# Zig

# Miscellaneous

## %git_clone
Downloads the source code via `git clone` with the `--depth=1`, `-q`, and `--recursive-submodules` flags. Should only be used when downloading a compressed source cannot be used (for example, if the build process expects a git environment or the release tarball doesn't contain submodules).

## %evr
used for declaring how a package interacts with others, for acampe, in a `Requires:` tag.
For example, `Requires: %{name} = %evr`
expands to `%{?epoch:%{epoch}:}%{version}-%{release}`.


| Macro                           | Function                                                               |
| ------------------------------- | ---------------------------------------------------------------------- |
| `%nim_prep`                     | Setting up `nimble`                                                    |
| `%nim_build` or `%nim_c`        | Builds a nim package. Requires an argument to `src/pkgname`            |
| `%nim_tflags`                   |                                                                        |
| `%nim_lflags`                   |                                                                        |
| `%files_libs`                   |                                                                        |
| `%_sccache`                     | `/usr/bin/sccache`                                                     |
| `%sccache_prep`                 | Sets up environment variables for `sccache`                            |
| `%cargo_prep_online_sccache`    |                                                                        |
| `%bun_common_envvars`           |                                                                        |
| `%__bun`                        | `/usr/bin/env %{bun_common_envvars} /usr/bin/bun`                      |
| `%__bunx`                       |                                                                        |
| `%bun_build`                    | bun build                                                              |
| `%bun_audit`                    | bun audit, for use in the `%check` section                             |
| `%bun_pm_trust`                 |                                                                        |
| `%vendor_pnpm`                  | If PNPM is not usable/available from repo                              |
| `%pnpm_common_envvars`          |                                                                        |
| `%__pnpm`                       | `/usr/bin/env %{pnpm_common_envvars} %{?with_vendored_pnpm:%{rpmbuilddir}/pnpm/pnpm}%{!?with_vendored_pnpm:/usr/bin/pnpm}` |
| `%__pnpx`                       |                                                                        |
| `%pnpm_build`                   | pnpm build                                                             |
| `%pnpm_audit`                   | Audit pnpm if package uses bundled Node dependencies. For use in the `%check` section |
| `%pnpm_audit_fix`               | Fix dependencies using PNPM                                            |
| `%pnpm_approve_builds`          | Approve dependency scripts if needed                                   |
| `%yarn_common_envvars`          |                                                                        |
| `%__yarn`                       | `/usr/bin/env %{yarn_common_envvars} /usr/bin/yarn`                    |
| `%__yarn_dlx`                   |                                                                        |
| `%yarn_build`                   | yarn build                                                             |
| `%yarn_audit`                   | Audit yarn if package uses bundled Node dependencies. For use in the `%check` section |

| `%npm_common_envvars`           |                                                                        |
| `%npm_buildflags`               |                                                                        |
| `%set_node_build_flags`         |                                                                        |
| `%__npm`                        |                                                                        |
| `%__npx`                        |                                                                        |
| `%npm_build`                    | npm build                                                              |
| `%__nvm`                        |                                                                        |
| `%npm_prep`                     |                                                                        |
| `%fetch_node_tests`             |                                                                        |
| `%npm_install`                  |                                                                        |
| `%npm_audit`                    |                                                                        |
| `%npm_audit_fix`                |                                                                        |
| `%__npm_license_checker`        |                                                                        |
| `%npm_license_summary`          |                                                                        |
| `%npm_license`                  |                                                                        |
| `%node_self_test`               |                                                                        |
| `%npm_test`                     |                                                                        |
| `%zig_build_target`             | Check out our Zig packaging guidelines [here](https://developer.fyralabs.com/terra/policy#zig) |
