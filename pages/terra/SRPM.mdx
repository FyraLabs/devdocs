---
title: SRPM Macros
description: "Documentation on the macros included in the anda-srpm-macros package."
---

import { Callout } from "nextra/components";

# SRPM Macros

We provide SPRM macros to ease packaging and better integrate into our workflow. Please use these macros when possible when contributing to Terra.

These are provided in the `anda-srpm-macros` package. If you use them, make sure to add `anda-srpm-macros` as a `BuildRequires:` in the spec file.

You may need to refer to the [miscellaneous packaging guidelines](./policy#miscellaneous-packaging-guidelines) for more details.

If you would like to add/fix/update these macros, or need to raise an issue, please do so in the [SRPM macros repository](https://github.com/terrapkg/srpm-macros), or reach out to us [here](https://wiki.ultramarine-linux.org/en/community/community/).

For other macros available in Fedora/Terra, check out our unofficial [macros list](../rpm/macros).

<Callout type="info">
  The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
  NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and
  "OPTIONAL" in this document are to be interpreted as described in
  [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119) and
  [RFC 8174](https://www.rfc-editor.org/rfc/rfc8174).
</Callout>

## Directories
These macros define certain system directories, and SHOULD be used in place of the raw directory path.

### %__anda_develfiles
[TODO]

### %_anda_srpm_macros_dir
Expands to: `/usr/libexec/anda-srpm-macros`.
Anda directory for scripts such as `find-develinfo.sh` used by Anda macros.

### %__anda_libsfiles
[TODO]

### %_appsdir
Expands to: `%_datadir/applications` or `/usr/share/applications`.
This may seem like a directory to place the application itself into, but this directory SHOULD ONLY be used for the applicaitons `.desktop` file.

### %elvish_completions_dir
`%_datadir/elvish/lib/completions`

### %_hicolordir 
Expands to: `%_iconsdir/hicolor`, or `/usr/share/icons/hicolor`.
The directory that SHOULD be used when installing application `.png` files. Note that you will then need to install the (typically app icon) file to the `apps` folder within the fixed-size directory in `%_hicolordir`.

For example:

```bash
# Lets say package 'foo' has a 16x16 and 64x64 .png
install -Dm644 icons/16x16.png %{buildroot}%{_hicolordir}/16x16/apps/%{name}.svg
install -Dm644 icons/64x64.png %{buildroot}%{_hicolordir}/64x64/apps/%{name}.svg
```

If the file is a `.svg`, use the macro below.

### %_scalableiconsdir 
Expands to: `%_hicolordir/scalable/apps`, or `/usr/share/icons/hicolor/scalable/apps/`.
The directory that SHOULD be used when installing application `.svg` files to.
You do not need to specify any folders for this macro, add the file can be added to the end of this macro.
For example:

```bash
install -Dm644 icons/%{name}.svg %{buildroot}%{_scalableiconsdir}/%{name}.svg
```

If the file is a `.png`, use the macro above.

### %__pnpm
`/usr/bin/env %{pnpm_common_envvars} %{?with_vendored_pnpm:%{rpmbuilddir}/pnpm/pnpm}%{!?with_vendored_pnpm:/usr/bin/pnpm}`
[TODO]: Should macros like these be in the directories section?

### %__pnpx
[TODO]

### %rpmbuilddir
`%{?builddir}%{?!builddir:%{_builddir}}`.

## Electron
These macros assist with the general packaging of applications that use [Electron](https://www.electronjs.org/).

### %electronmeta
Set up all basic requirements including build macros for building an Electron app.

Rundown of what all `%electronmeta` does:
- Converts `%{_target_cpu}` (the RPM build architecture) into `%{_electron_cpu}`, the Electron format for architectures it is compatible with.
  - Defines `%{_electron_cpu}` for x86_64 architectures as `x64`.
  - Defines `%{_electron_cpu}` for aarch64 architectures as `arm64`.
  - Defines `%{_electron_cpu}` for x86 architectures as `ia32`.
  - Defines `%{_electron_cpu}` for armv7l architectures as `armv7l`.
    - These are defined because Electron names the build files and directories after the architecture
    - The macros used to build Electron apps (`%npm_build`, `%bun_build`, `%pnpm_build`, and `%yarn_build`) all require this to be set
    - In some cases, these architectures are used in the source tarballs for Electron projects
    - This can also be used to help work with the files if you need to do anything manually
- Defines `%__provides_excludes` to make sure Electron apps are not flagged as providers of their bundled dependencies, such as FFmpeg libraries.
- Defines `%__requires_excludes` based on architecture to prevent Electron Builder's cross-compilation from causing false dependency positives from RPM.
- Sets `%debug_package` to `%{nil}` to prevent stripping of bundled libraries and/or build failures due to not enough data to strip.
- Sets the build and runtime dependencies. The -a flag can be used to pull additional build dependencies that are sometimes needed when building through NPM in particular.
- Sets the `ExclusiveArch` field to only the architectures Electron supports.
- Defines the bundled dependencies as bundled. NOTE: This only defines Electron's bundled dependencies, not any Node modules the app may also bundle.

This ensures packagers do not need to manually set these for every Electron app's spec, hopefully eliminating depsolver problems and helping reduce common build issues.

### %electron_install
Install files built using Electron Builder.

By default, the install steps are:
1. Make the install directory
  - This will be in the `%{_libdir}` (/usr/lib on 32-bit architectures and /usr/lib64 on 64-bit ones)
  - This is done because programs with bundled dependencies (Electron, Node modules, and more) MUST have these dependencies kept together
2. Install the app's files
3. Symlink the app's binary to the bin directory
4. Install the app's icons

`%electron_install` supports several flags to help control variables of the install. Most of the fallbacks if none are passed are the name of the package.
- `-b` must be used when the app's executable differs from the name of the package.
- `-d` can be used to install the app under a different directory than the name of the package.
- `-i` must be used when the app's desktop file points to an icon name different from the name of the package.
- `-l` can be used to fetch all licenses including the bundled ones and put them in a directory in the `%{builddir}`. You can then put them in the license directory using `%license %{rpmbuilddir}/bundled_licenses/*` (for more information on `%{rpmbuilddir}` and why we have it, see [TBA])
- `-s` can be used to choose the name of the symlink.
- `-S` can be used to create an additional symlink with a different name. Useful when an app has two interchangeable common names.
- `-D` can be used to handle automatic installation of the .desktop file. This ONLY works if Electron Builder builds an AppImage, and should not be used if the source contains a desktop file.
- `-E` can be used to set the "--enable-features" flag in the desktop file. Features to enable must be comma separated without spaces.
- `-O` can be used to set the Ozone flatform the Electron app will run on. If no arguments are supplied, it will fall back to auto. Accepted arguments are `-Ox11` and `-Owayland`
- `-U` can be used to set either `%u` or `%U` in the desktop file. This REQUIRES you do not use `u` as a macro name for any reason.
  - `%u` means that a desktop file can only read one URL at a time, `%U` means that it can read multiple at a time.
  - Defer to what the desktop file originally contained if you are unsure.

Example:
- The command `%electron_install -b app -i app -s app -S alsoapp -D -Owayland -U %u -E WaylandWindowDecorations` would install the program with:
  - Icons named `app.png`
  - A symlink named `app`
  - A second symlink called `alsoapp`
  - A desktop file with the `Exec` line reading `Exec=/usr/lib(64)/pkgname/app --enable-features=WaylandWindowDecorations --ozone-platform=wayland %u`

### %electron_license
The license for bundled Electron.
NOT set by default in `%electronmeta` because you cannot set the license field twice.
MAY be used in combination with manually adding the other relevant licenses (if this is done, a proper license tag would be `License: XXX-x.x AND %electron_license`.

To enable, must have `%bcond bundled_electron 1` in the [preamble](../rpm/sections#preamble) of the spec.

### %electron_arches
The architectures Electron supports. Automatically set as `ExclusiveArch` when using `%electronmeta`.

As written, the macro is:
- `%{x86_64} %{ix86} %{arm64} armv7l armv7hl armv7hnl`

Which expands fully to:
- `x86_64 x86_64_v2 x86_64_v3 x86_64_v4 amd64 em64t i386 i486 i586 i686 pentium3 pentium4 athlon geode aarch64 armv7l armv7hl armv7hnl`

Which simply means Electron supports x86_64, x86, aarch64/ARM64, and armv7l.

## Go
These macros assist with building go projects.

### %go_task
Should be used in place of `go-task`.

## JavaScript/JavaScript Package Managers
These are macros to assist with the general packaging of applications that use JavaScript runtimes/nodeJS
[TODO]: make this sound not stupid
[TODO]: descriptions for the sub-sections
[TODO]: examples/links to examples of how to use the macros here (at least the common ones)

### Bun Macros
[TODO]

#### %bun_common_envvars
[TODO]

#### %__bun
Expands to: `/usr/bin/env %{bun_common_envvars} /usr/bin/bun`

#### %__bunx
[TODO]

#### %bun_build
Should be used in place of `bun build`.

#### %bun_audit
bun audit, for use in the `%check` section.

#### %bun_pm_trust
[TODO]

### Node Macros
[TODO]

#### %fetch_node_tests
[TODO]

### NPM Macros
[TODO]

#### %npm_common_envvars
[TODO]

#### %npm_buildflags
[TODO]

#### %set_node_build_flags
[TODO]

#### %__npm
[TODO]

#### %__npx
[TODO]

#### %npm_build
Should be used in place of `npm build`.

#### %__nvm
[TODO]

#### %npm_prep
[TODO]

#### %npm_install
[TODO]

#### %npm_audit
[TODO]

#### %npm_audit_fix
[TODO]

#### %npm_license_summary
[TODO]

#### %npm_test
[TODO]

#### %node_self_test
[TODO]

#### %__npm_license_checker
Expands to: `/usr/bin/license-checker`.
Runs the npm [`license-checker`](https://www.npmjs.com/package/license-checker) command.

Example output:

```
/usr/bin/license-checker
└─ @fyralabs/devdocs@@0.0.1
   ├─ licenses: MIT
   ├─ repository: https://github.com/FyraLabs/devdocs
   ├─ publisher: Lleyton Gray
   ├─ email: lleyton@fyralabs.com
   ├─ path: /home/owen/Documents/Projects/devdocs
   └─ licenseFile: /home/owen/Documents/Projects/devdocs/LICENSE
```

#### %npm_license
Expands to: `/usr/bin/license-checker --limitAttributes licenses`.
Above macro, but limits the output to only the license.

Example output:

```
/usr/bin/license-checker --limitAttributes licenses
└─ @fyralabs/devdocs@@0.0.1
   └─ licenses: MIT
```

### PNPM Macros

#### %vendor_pnpm
Use if PNPM is not usable/available from repo

#### %pnpm_common_envvars
[TODO]

#### %__pnpx
[TODO]

#### %pnpm_build
Should be used in place of `pnpm build`.

#### %pnpm_audit
Audit pnpm if package uses bundled Node dependencies. For use in the `%check` section

#### %pnpm_audit_fix
Fix dependencies using PNPM

#### %pnpm_approve_builds
Approve dependency scripts if needed

### Yarn Macros
[TODO]

#### %yarn_common_envvars
[TODO]

#### %__yarn
Expands to: `/usr/bin/env %{yarn_common_envvars} /usr/bin/yarn`.

#### %__yarn_dlx
[TODO]

#### %yarn_build
Should be used in place of `yarn build`.

#### %yarn_audit
Audit yarn if package uses bundled Node dependencies. For use in the `%check` section

## Nim
These macros assist with building Nim projects.

### %nim_prep
Set up build environment with required packages via `nimble setup`.

### %nim_build (or %nim_c)
Builds a nim package.
Requires an argument to `src/pkgname`

### %nim_tflags
C Compiler flags to Nim.

### %nim_lflags
Linker flags to Nim.

## Rust
These macros assist with building Rust projects.

### %cargo_prep_online
Enables internet access for `cargo_prep`. Replaces `%cargo_prep` in `%prep`.

### %cargo_license_online
Enables internet access for `cargo_license`.
Replaces `%cargo_license` in `%build`.

### %cargo_license_summary_online
Enables internet access for `cargo_license_summary`.
Replaces `%cargo_license_summary` in `%build`.

### %cargo_vendor_manifest_online
Enables internet access for `cargo_vendor_manifest_online`. 
Replaces `%cargo_vendor_manifest` in `%build`. 

### %crate_install_bin
Used to install crates that build as single binary.
Can be used instead of `%cargo_install` when [this](https://github.com/terrapkg/packages/issues/1169) is applicable.

### %rustup_nightly
Used in `%prep` for nightly `rustc`/`cargo` from `rustup`.

### %cargo_prep_online_sccache
[TODO]

## sccache
These macros are fur using [sccache](https://github.com/mozilla/sccache) in your builds.

### %_sccache
Exapnds to: `/usr/bin/sccache`.

### %sccache_prep
Sets up environment variables for `sccache`.

## Subpackages
These macros assist with packages that require certain subpackage types.
For example, some packages will build application and library files. Using `%pkg_devel_files` will greatly help you in making the library files (`-devel`) subpackage.
More information on subpackages can be found on the [Fedora Packaging Guidelines](https://docs.fedoraproject.org/en-US/packaging-guidelines/#_mixed_use_packages).

### %files_libs
This macro creates library subpackages and installs the library files.

The default subpackage name will be `%name-libs`, but you can override this with `-n NEWNAME`

[TODO]: Should this even be used? No package uses it and `%pkg_devel_files seems to do the same thing?

### %pkg_completion
This macro creates shell completion subpackages and installs the shell completion files.
This macro SHOULD be used if your package provides shell completion files.
Use the below flags according to the shell completion files your package uses:

```
-B: bash (but the completion file doesn't have `.bash` extension)
-b: bash
-e: elvish
-f: fish
-z: zsh
```

For specifying the name (the default will be your `%name`) of the shell completion subpackages (if needed):
```
-n pkgname
```

Can also pass `cmd1`, etc. as the commands the completion files are for.

Example using all flags:
```
%pkg_completion -Bbefz -n pkgname cmd1 cmd2 ...
```

A good example spec that uses this macro is [yadm](https://github.com/terrapkg/packages/blob/d861164790b3d77f5ee094d303de2dfc3299ef8b/anda/devs/yadm/yadm.spec#L22).
This spec creates these packages:

```
yadm-x.x.x-x.fcxx.noarch.rpm - contains all core package files.
yadm-bash-completion-x.x.x-x.fcxx.noarch.rpm - contains `/usr/share/bash-completion/completions/yadm`
yadm-fish-completion-x.x.x-x.fcxx.noarch.rpm - contains `/usr/share/fish/vendor_completions.d/yadm.fish`
yadm-zsh-completion-x.x.x-x.fcxx.noarch.rpm - contains `/usr/share/zsh/site-functions/_yadm`
```

### %pkg_devel_files
[TODO]: flesh this out lol
Set the summary & description, then find development `%files`.

```
%package devel
# generates Summary:, %description devel and the file lists
# use -F to omit %files
# use -n to manually specify name other than `%name-%devel`
%pkg_devel_files
```

### %pkg_static_files
Set the summary & description, then find static libraries.

### %pkg_libs_files
Set the summary & description, then find dynamic library files (`%_libdir/*.so.*`).

## Zig
These macros assist with building Zig projects.

### %zig_build_target
Many Zig projects rely on ReleaseFast (or more rarely, ReleaseSmall) builds for runtime optimization, and some Zig projects only work correctly when built for certain microarchitectures or higher (usually, this is `x86_64_v2` instead of `baseline` due to reliance on SIMD).
If either of the above are the case for your package, you can use `%zig_build_target` with appropriate options in the `%build` or `%install` section depending on how the project is built (as some can be built directly into root by setting the `DESTDIR=%{buildroot}` variable).

Example:

```rpmspec
%build
%{zig_build_target -r fast -c x86_64_v2} \
  -Demit-docs
```

Note that `-c` also works as a fallback option to the target architecture set by RPM if no following argument is supplied. However, this can **_only_** be used when RPM and Zig's architecture formats are the same, otherwise the build will fail.
For projects where dynamic linking of all dependencies is simply not possible (such as the version in the Fedora repos being too new or too old) or that have no dependencies to link, you can pass the `-s` flag. You can (and should) still dynamically link compatible dependencies by using `-fsys=pkgname`.

More information can be found on our [Zig packaging guidelines](../terra/policy#zig).

## Miscellaneous
General macros that do not fit into a specific category.

### %__anda_staticfiles
Expands to: `%_anda_srpm_macros_dir/find-staticinfo.sh %buildroot > anda-staticfiles.list`.
Creates anda-staticfiles.list file in `%{buildroot}` to be used by `%pkg_static_files`.

### %evr
used for declaring how a package interacts with others, for acampe, in a `Requires:` tag.
For example, `Requires: %{name} = %evr`
expands to `%{?epoch:%{epoch}:}%{version}-%{release}`.

### %git_clone
Downloads the source code via `git clone`, and passes useful (in this situation) flags such as`--depth 1`, `-q`, `--recursive-submodules`, and `-j${RPM_BUILD_NCPUS}`.
A git URL and a `%version` or `%commit` SHOULD be passed to this macro.
Below is an example of how a spec that tracks version tages from a GitHub repo, and needs to git clone the source could handle this:

```rpmspec
Version:        0.8.0
---
URL:            https://github.com/ethangreen-dev/lovely-injector
---
%prep
%git_clone %{url} v%{version}
```

Below is an example of how a spec that tracks the latest commit from a GitHub repo, and needs to Git clone the source could handle this:

```rpmspec
%global commit 9417838c91aab6088778089b9a3e8330bca53fbd
---
URL:           https://github.com/ad-oliviero/uwufetch
---
%prep
%git_clone %{url} %{commit}
```

`%git_clone` SHOULD only be used when the source tarballs provided by upstream does not include all required sources in the repository (e.g., if the build process expects a Git environment or the tarball doesn't contain submodules).
