---
title: Macros
description: "Documentations for different RPM macros."
# vi: noet ci pi sts=0 sw=2 ts=2
---

import { Callout } from "nextra/components";
import { Split } from "../../components/split";

# RPM Macros

Technically, there are 3 types of "macros":

- `%{rpm_macro}`: Normal RPM macros
- `%(echo "hi" | sed 's/hi/hello/')`: Shell macros that expands to the output of the commands
- `%[v"1.2.3~1" < v"1.2.3"]`: RPM [expression]

This document only covers the first type.

<Callout type="info">
    This page does not cover Terra-specific (Anda SRPM) macros. For documentation on these macros, see [here](../terra/srpm). For documentation on our AppStream MetaInfo macros, see [here](../terra/appstream).
</Callout>

If you are new to RPM packaging, you should first check out the macros with the ğŸ”° icon.
On a computer, the right hand side of this page shows you the list of macros.

If you would like to learn more about the RPM macro syntax, check out [Macro syntax](./macro).

## Legend

- ğŸ”¢ : Parameterized macro.
- ğŸ”¦ : Relatively uncommon.
- ğŸ”° : Relatively common.
- ğŸš¸ : Not recommended in Terra.
- ğŸ› ï¸ : Advanced.
- ğŸ”© : Usually used with `rpm -E` but not in spec files.
- ğŸ·ï¸ : Usually defined but not used directly.

## RPM Built-in Macros

### Macro Manipulation

<Callout type="info">
  This list is obtained from
  [rpmspec-rs](https://github.com/rpm-rs/rpmspec-rs/blob/464c8caab5d451517691cc2885bd77912aa53190/src/macros.rs),
  which is obtained from [RPM
  docs](https://github.com/rpm-software-management/rpm/blob/b043604b9eb684dc761aeacf55a784632ca0ebcd/docs/manual/macros.md#builtin-macros).
</Callout>

#### `%define` ğŸ”° [#define]

Defines a macro locally.

Macros defined with `%define` will not last to another RPM section.
For example, if used in preamble section, the macro will be automatically undefined in `%prep`.

To make sure a macro lasts for the entire spec file, use `%global` instead.

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    %build
    %define my_macro Hello, World!
    echo %my_macro

    %install
    echo %my_macro
    ```

  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    %build
    echo Hello, World!

    %install
    echo %my_macro
    ```

  </Split.Right>
</Split>

#### `%global` ğŸ”° [#global]

Defines a macro globally.

As oppose to [`%define`](#define), macros defined with `%global` will last for the entire spec file.

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    %global cat Meow!!!

    %prep
    echo nya %cat

    %build
    echo %cat
    ```

  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    %prep
    echo nya Meow!!!

    %build
    echo Meow!!!
    ```

  </Split.Right>
</Split>

#### `%undefine` ğŸ”¦ [#undefine]

Undefine a macro.

Technically this does not always undefine the macro specified.
Instead, this pops the latest definition from the macro stack.

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    %global cat Meow!

    %prep
    %global cat Nyaa!
    echo %cat

    %build
    %undefine cat
    echo %cat

    %install
    %undefine cat
    echo %cat
    ```

  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    %prep
    echo Nyaa!

    %build
    echo Meow!

    %install
    echo %cat
    ```

  </Split.Right>
</Split>

#### `%dnl` ğŸ”° [#dnl]

Comments.

Similar to `# â€¦`, this can comment out anything in `%{dnl:â€¦}` or after `%dnl â€¦`.
The difference with `# â€¦` is that `%dnl` prevents macro expansions,
while macros in `# â€¦` are actually expanded.

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
		%define meow a
		# comment %meow
		%dnl comment %meow
		```
  </Split.Left>
  <Split.Right>
		```rpmspec filename="expand.spec"
    # comment a
		```
	</Split.Right>
</Split>

#### `%{load:â€¦}` ğŸ”¦ğŸš¸ [#load]

Load a macro file.

#### `%{expr:â€¦}` ğŸ”¦ [#expr]

Expand all macros in the body, then evaluate the body as an [expression].

```sh
$ rpm -D 'foo 1 + 2' -E '%[%foo]'
error: macro expansion did not return an integer: %foo
error:                                            ^
error: expanded string: 1 + 2

$ rpm -D 'foo 1 + 2' -E '%{expr:%foo}'
3
```

#### `%{expand:â€¦}` ğŸ› ï¸ [#expand]

Double-expand the macro.

  <Split>
    <Split.Left>
      ```rpmspec filename="example.spec"
      %define nya foo
      %define meow %{expand:%%nya}
    
      echo %meow
      ```
    </Split.Left>
    <Split.Right>
      ```rpmspec filename="expand.spec"
      echo foo
      ```
    </Split.Right>
  </Split>

#### `%{lua:â€¦}` ğŸ› ï¸ [#lua]

Embed lua code.

<Callout type="warning">
  Since RPM expands macros when the source RPM (SRPM) is created,
  the lua code is executed during that stage.

This means that the lua code is executed not during the stage it is defined in, but
way before even `%prep`.

</Callout>
<Callout type="warning">
  Do NOT comment out lua code using `# â€¦`, `%dnl â€¦` or `%{dnl:â€¦}`.

Lua comments must start with `-- â€¦`.

In `rpmspec-rs`, a space must be present after `--`.

</Callout>
<Callout type="info">
  Documentations for the embedded Lua interpreter, including specific functions available,
  are available at https://rpm-software-management.github.io/rpm/manual/lua.html.
</Callout>

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    %global my_macro Hello
    %{lua:
      -- this lua block expands to the input
      -- to all `print()` statements
      print("%prep\necho " ..
        rpm.expand("%my_macro from lua!") ..
        "\n")
    }
    ```
  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    %prep
    echo Hello from lua!
    ```
  </Split.Right>
</Split>

#### `%{macrobody:â€¦}` ğŸ”© [#macrobody]

Expand to the definition of the given macro.

```sh
$ rpm -E '%dist'
.um41

$ rpm -E '%macrobody dist'
%{?distprefix}.um41%{?with_bootstrap:~bootstrap}
```

#### `%{quote:â€¦}` ğŸ”¦ğŸ› ï¸ [#quote]

Does nothing. You heard me, this macro literally does nothing.

But because of that it's very useful.
This can be used to pass arguments with spaces to parameterized macros:

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    echo %gsub %{quote:hello hello} %{quote:^hello} bye
    ```
  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    echo bye hello
    ```
  </Split.Right>
</Split>

### String Operations

#### `%gsub â€¦` ğŸ”¢ğŸ”¦ğŸ› ï¸ [#gsub]

Equivalent to `%{lua: string.gsub("%1", "%2", %3, %?4)}`,
where `%n` represents the n-th argument to `%gsub`.

In short, this replaces `%?4` occurrences of `%2` in `%1` to `%3`.
`%4` is optional and defaults to infinity.

`%2` is treated as a [lua pattern](https://www.lua.org/pil/20.2.html).

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    echo %gsub %{quote:hello hello} %{quote:^hello} bye
    ```
  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    echo bye hello
    ```
  </Split.Right>
</Split>

#### `%{len:â€¦}` [#len]

Obtains the length of the given text.

<Split>
  <Split.Left>
    ```rpmspec filename="example.spec"
    %define foo meow now!
    echo %{len:%foo}
    ```
  </Split.Left>
  <Split.Right>
    ```rpmspec filename="expand.spec"
    echo 9
    ```
  </Split.Right>
</Split>

#### `%{lower:â€¦}` [#lower]

Turn the input into ASCII-lowercase.

#### `%{upper:â€¦}` [#upper]

ASCII-uppercase.

#### `%rep â€¦` ğŸ”¢ğŸ”¦ [#rep]

Repeat the first input (`%1`) `n`-times, `n` given by `%2` (lua `string.rep()`).

#### `%{reverse:â€¦}` [#reverse]

#### `%sub â€¦` ğŸ”¢ğŸ”° [#sub]

Expand to substring (lua `string.sub()`).

```sh
$ rpm -E '%sub abc 2 3'
bc
```

#### `%{shescape:â€¦}` [#shescape]

Wrap the input with single quotes and also escape preexisting single-quotes correctly,
so that the input can be safely passed as arguments to shell commands.

```sh
$ rpm -E "echo %{shescape:this is some 'text'}"
echo 'this is some '\''text'\'''

$ rpm -E "%(echo %{shescape:this is some 'text'})"
this is some 'text'
```

#### `%{shrink:â€¦}` [#shrink]

Trim leading and trailing ASCII-whitespace, and reduce intermediate whitespace to a single space.

### File and Path Operations

#### `%{basename:â€¦}` ğŸ”¦ [#basename]

> basename(1) macro analogue

#### `%{dirname:â€¦}` ğŸ”¦ [#dirname]

> dirname(1) macro analogue

#### `%{exists:â€¦}` ğŸ”¦ [#exists]

> test file existence, expands to 1/0

#### `%{suffix:â€¦}` ğŸ”¦ [#suffi]

> expand to suffix part of a file name

#### `%{url2path:â€¦}` ğŸ”¦ [#url2path]

> convert url to a local path

#### `%{uncompress:â€¦}` [#uncompress]

> expand to a command for outputting argument file to stdout, uncompressing as needed

This macro is used in [`%setup â€¦`](#setup) for uncompressing source files.

### Environment info

#### `%{getncpus:â€¦}` [#getncpus]

When used as `%{getncpus}` with no arguments, expand to the number of available CPU cores.

Also accept extra arguments:

> accepts arguments `total`, `proc` and `thread`, additionally accounting for available memory (e.g. address space limitations for threads)

However, `%getncpus total`, `%getncpus proc` and `%getncpus thread` produce the same results as far as
concerned. It is suspected that the arguments in most cases have no effect to the output.

#### `%getconfdir` ğŸ”¦ [#getconfdir]

> expand to rpm "home" directory (typically /usr/lib/rpm)

#### `%{getenv:...}` ğŸ”¦ [#getenv]

> getenv(3) macro analogue

#### `%rpmversion` ğŸ”¦ [#rpmversion]

> expand to running rpm version

### Output

#### `%{echo:â€¦}` ğŸ”¦ [#echo]

> print ... to stdout

<Callout type="warning">
  The printing happens when the macro is evaluated and expanded, not at the
  section/position it is written.
</Callout>

#### `%{warn:â€¦}` ğŸ”¦ [#warn]

> print warning: ... to stderr

Produce an RPM warning, which is immediately shown in console stderr,
and displayed again at the end of the `rpmbuild` execution (after `Executing(rmbuild)`).

<Callout type="warning">
  The printing happens when the macro is evaluated and expanded, not at the
  section/position it is written.
</Callout>

#### `%{error:â€¦}` ğŸ”¦ [#error]

> print error: ... to stderr and return an error

Produce an RPM warning, which is immediately shown in console stderr, then immediately
perform `Executing(rmbuild)` and exit with a summary of all warnings and errors.

<Callout type="warning">
  The printing happens when the macro is evaluated and expanded, not at the
  section/position it is written.
</Callout>

#### `%{verbose:â€¦}` ğŸ”¦ [#verbose]

> `%verbose`: expand to 1 if rpm is in verbose mode, 0 if not
>
> `%{verbose:...}`: expand to ... if rpm is in verbose mode, the empty string if not

### Spec-specific Macros

#### `%{S:â€¦}` [#S]

> expand ... to &lt;source&gt; file name

Expand to the path to the source file. This is just a fancy macro that transforms `%{S:123}` to `%SOURCE123`.

	<Split>
		<Split.Left>
			```rpmspec filename="example.spec"
			Source0: https://repos.fyralabs.com/um42/comps.xml
			
			%prep
			cat %{S:0}
			echo %{S:1}
			```
		</Split.Left>
		<Split.Right>
			```rpmspec filename="expand.spec"
			Source0: https://repos.fyralabs.com/um42/comps.xml
			
			%prep
			cat %{_sourcedir}/comps.xml
			echo %SOURCE1
			```
		</Split.Right>
	</Split>

#### `%{P:â€¦}` [#P]

> expand ... to &lt;patch&gt; file name

As you may have guessed, this is basically the `Patch:` version of [`%{S:â€¦}`](#S).

### Diagnostics

#### `%trace` ğŸ”¦ğŸ› ï¸ [#trace]

> toggle print of debugging information before/after expansion

#### `%dump` ğŸ”© [#dump]

> print the active (i.e. non-covered) macro table

When you want to find a macro that has the string `x86_64_v3`, you can run:

```sh
rpm -E '%dump' 2>&1 | grep x86_64_v3
```

Or you can just use `less` instead of `grep`.

#### `%__file_name` ğŸ”¦ [#__file_name]

> current file (if parsing a file)

#### `%__file_lineno` ğŸ”¦ [#__file_lineno]

> line number in current file (if parsing a file)

## Common Macros

### Miscellaneous

#### `%nil` ğŸ”° [#nil]

Expand to nothing.

Defined as `%{!?nil}`.

### In Preamble

#### `%forgemeta â€¦` ğŸ”¢ğŸ”° [#forgemeta]

See https://docs.fedoraproject.org/en-US/packaging-guidelines/SourceURL/#_using_forges_hosted_revision_control.

Parameterized as `%forgemeta(z:isva)`:
- `-v`: verbose
- `-i`: informative
- `-s`: silent
- `-a`: process all source archives (when you have `%forgeurl0`, `%forgeurl1`, â€¦)
- `-z n`: process the `n`-th source archive

#### `%forgeautosetup â€¦` ğŸ”¢ [#forgeautosetup]

Somehow pretty rare.

Parameterized as `%forgeautosetup(z:vNS:p:q)`.

#### `%forgesetup â€¦` ğŸ”¢ğŸ”° [#forgesetup]

Parameterized as `%forgesetup(z:va)`.

#### `%forgeversion â€¦` ğŸ”¢ğŸ”¦ [#forgeversion]

Parameterized as `%forgeversion(pz:ab:)`.

#### `%debug_package` ğŸ”°ğŸ·ï¸ [#debug_package]

When you see:

```ansi
error: Empty %files file [1;3m%_builddir[0m/[1;3m%buildsubdir[0m/debugsourcefiles.list
```

This means RPM is trying to generate a `%{name}-debuginfo`/`%{name}-debugsource` package.
You can disable this automatic behavior by setting:

```rpmspec
%define debug_package %nil
```

Then RPM will not strip debug symbols.

#### `%_build_id_links` ğŸ·ï¸ [#_build_id_links]

When you see problems with `/usr/lib/.build-id`, try setting this to `none`.

In `/usr/lib/rpm/macros`:
```rpmspec
#
# Defines how and if build_id links are generated for ELF files.
# The following settings are supported:
#
# - none
#   No build_id links are generated.
#
# - alldebug
#   build_id links are generated only when the __debug_package global is
#   defined. This will generate build_id links in the -debuginfo package
#   for both the main file as /usr/lib/debug/.build-id/xx/yyy and for
#   the .debug file as /usr/lib/debug/.build-id/xx/yyy.debug.
#   This is the old style build_id links as generated by the original
#   find-debuginfo.sh script.
#
# - separate
#   build_id links are generate for all binary packages. If this is a
#   main package (the __debug_package global isn't set) then the
#   build_id link is generated as /usr/lib/.build-id/xx/yyy. If this is
#   a -debuginfo package (the __debug_package global is set) then the
#   build_id link is generated as /usr/lib/debug/.build-id/xx/yyy.
#
# - compat
#   Same as for "separate" but if the __debug_package global is set then
#   the -debuginfo package will have a compatibility link for the main
#   ELF /usr/lib/debug/.build-id/xx/yyy -> /usr/lib/.build-id/xx/yyy
%_build_id_links compat
```

#### `%_missing_build_ids_terminate_build` ğŸ·ï¸ [#_missing_build_ids_terminate_build]

Still having problems with `/usr/lib/.build-id`? Try setting this to `0`.

In `/usr/lib/rpm/macros`:
```rpmspec
#
# Should an ELF file processed by find-debuginfo.sh having no build ID
# terminate a build?  This is left undefined to disable it and defined to
# enable.
#
%_missing_build_ids_terminate_build    1
```

#### `%__strip` ğŸ·ï¸ [#__strip]

In some cases (e.g. JavaScript binaries) stripping the binaries may break the
executable. To disable stripping, override the strip call:
```rpmspec
%global __strip /bin/true
```

#### `%__requires_exclude` ğŸ·ï¸ [#__requires_exclude]

Since `rpmbuild` automatically generates `Requires:` by looking at
what things the binaries are linked to, you may disable that by adding a regex to this macro:
```rpmspec filename="example.spec" {6}
# https://github.com/terrapkg/packages/blob/7f0fd6b6a8993d17832403960d4343899cfb0474/anda/apps/youtube-music/youtube-music.spec#L5
%define debug_package %nil

# Exclude private libraries since this is bundled with electron
%global __provides_exclude ^((libffmpeg[.]so.*)|(lib.*\\.so.*))$
%global __requires_exclude ^((libffmpeg[.]so.*)|(lib.*\\.so.*))$
```

<Callout type="info">If you want to disable all automatic `Requires:`, set `AutoReq: 0`.</Callout>

#### `%__requires_exclude_from` ğŸ·ï¸ [#__requires_exclude_from]

```rpmspec filename="example.spec"
# https://github.com/terrapkg/packages/blob/7f0fd6b6a8993d17832403960d4343899cfb0474/anda/system/opentabletdriver/opentabletdriver.spec#L6
%global __requires_exclude_from ^/usr/lib/opentabletdriver/.*$
```

#### `%__provides_exclude` ğŸ·ï¸ [#__provides_exclude]

Similarly, since `rpmbuild` automatically generates `Provides:`, you may disable that:
```rpmspec filename="example.spec" {5}
# https://github.com/terrapkg/packages/blob/7f0fd6b6a8993d17832403960d4343899cfb0474/anda/apps/youtube-music/youtube-music.spec#L4
%define debug_package %nil

# Exclude private libraries since this is bundled with electron
%global __provides_exclude ^((libffmpeg[.]so.*)|(lib.*\\.so.*))$
%global __requires_exclude ^((libffmpeg[.]so.*)|(lib.*\\.so.*))$
```

<Callout type="info">If you want to disable all automatic `Provides:`, set `AutoProv: 0`.</Callout>

#### `%__provides_exclude_from` ğŸ·ï¸ [#__provides_exclude_from]

```rpmspec filename="example.spec" {8}
# https://github.com/terrapkg/packages/blob/7f0fd6b6a8993d17832403960d4343899cfb0474/anda/devs/asar/asar.spec#L7
%define debug_package %nil
%define __strip /bin/true
%global _build_id_links none

# Exclude private libraries
%global __requires_exclude libffmpeg.so
%global __provides_exclude_from %{_datadir}/%{name}/.*\\.so
```

#### `%__brp_mangle_shebangs_exclude_from` ğŸ”°ğŸ·ï¸ [#__brp_mangle_shebangs_exclude_from]

RPM tries to mangle shebangs (`#!`) by default (see
[`%__brp_mangle_shebangs`](#__brp_mangle_shebangs)).
If this breaks, you can ask it to exclude the files that matches a given regex.

```rpmspec filename="example.spec" {6}
# https://github.com/terrapkg/packages/blob/frawhide/anda/devs/zed/nightly/zed-nightly.spec#L9

%bcond_with check

# Exclude input files from mangling
%global __brp_mangle_shebangs_exclude_from ^/usr/src/.*$

%global crate zed
%global app_id dev.zed.Zed-Nightly

%global rustflags_debuginfo 0
```

#### `%__brp_mangle_shebangs_exclude` ğŸ·ï¸ [#__brp_mangle_shebangs_exclude]

Similar to above, but takes in regex for shebangs to exclude instead.

#### `%__brp_mangle_shebangs_exclude_file` ğŸ·ï¸ [#__brp_mangle_shebangs_exclude_file]

Similar to above, but takes in path to file that contains the regexes.

#### `%__brp_mangle_shebangs_exclude_from_file` ğŸ·ï¸ [#__brp_mangle_shebangs_exclude_from_file]

#### `%__brp_mangle_shebangs` ğŸ·ï¸

As a last resort to fixing bugs related to shebangs mangling shenanigans,
undefine this macro. You really should try using
[`%__brp_mangle_shebangs_exclude_from`](#__brp_mangle_shebangs_exclude_from) first though.

#### `%bcond_with â€¦` ğŸ”¢ğŸ”° [#bcond_with]

**DISABLE** a "conditional".

Parameterized as `%bcond_with()`.
Takes in 1 argument: the name of the "conditional".

For more information: https://rpm-software-management.github.io/rpm/manual/conditionalbuilds.html

#### `%bcond_without â€¦` ğŸ”¢ğŸ”° [#bcond_without]

**ENABLE** a "conditional".

Parameterized as `%bcond_without()`.
Takes in 1 argument: the name of the "conditional".

For more information: https://rpm-software-management.github.io/rpm/manual/conditionalbuilds.html

### In `%prep`

#### `%autosetup â€¦` ğŸ”¢ğŸ”° [#autosetup]

Uncompress the specified sources. By default, uncompress `%{SOURCE0}` (i.e. [`%{S:0}`](#s)).

Parameterized as `%autosetup(a:b:cCDn:TvNS:p:)`:
- `-n â€¦`: specify the top-level directory (i.e. root folder) name in the archive (default `%{name}-%{version}`)
- `-p n`: specify the `-p n` argument to [`%autopatch â€¦`](#autopatch)
- `-a n`: unpack `%{S:n}` after changing directory
- `-b n`: unpack `%{S:n}` before changing directory
- `-c`: create directory, `cd` into it, then unpack the source (useful if archive lacks top-level directory)
- `-C`: I've no idea what this does! â€” Mado
- `-D`: do not delete folder before unpacking sources
- `-T`: disable unpacking `%SOURCE0`
- `-v`: verbose. If specified, `%autosetup` will omit the `-q` argument to [`%setup`](#setup)
- `-S â€¦`: specify the SCM, equivalent to `%global __scm â€¦` then `%__scm_setup_git` (replace `git` with the argument). With this argument, the specified SCM will be set up in the uncompressed directory
- `-N`: do not run [`%autopatch â€¦`](#autopatch)

This is actually a wrapper around [`%setup`](#setup) and [`%autopatch â€¦`](#autopatch).

If you need to unpack multiple sources, see: http://ftp.rpm.org/max-rpm/s1-rpm-inside-macros.html

#### `%setup â€¦` ğŸ”¢ğŸš¸ [#setup]

Uncompress the specified sources. By default, uncompress `%{SOURCE0}` (i.e. [`%{S:0}`](#s)).

<Callout type="warning">
  Only available in a spec file.
</Callout>

In most cases you should use [`%autosetup â€¦`](#autosetup) instead. If you would like to use `%setup â€¦`,
we recommend adding the `-q` flag.

Parameterized as `%setup(a:b:cCDn:Tq)`: (need confirmation)
- `-n â€¦`: specify the top-level directory (i.e. root folder) name in the archive (default `%{name}-%{version}`)
- `-a n`: unpack `%{S:n}` after changing directory
- `-b n`: unpack `%{S:n}` before changing directory
- `-c`: create directory, `cd` into it, then unpack the source (useful if archive lacks top-level directory)
- `-C`: I've no idea what this does! â€” Mado
- `-D`: do not delete folder before unpacking sources
- `-T`: disable unpacking `%SOURCE0`
- `-q`: quiet, because by default `%setup â€¦` is verbose

If you need to unpack multiple sources, see: http://ftp.rpm.org/max-rpm/s1-rpm-inside-macros.html

The `%setup â€¦` macro does 3 things:
- prepare the destination
	- `%global %{buildsubdir}` to the argument given in `-n â€¦`
	- `mkdir -p %{builddir}`
		- note: `%{builddir}` is defined only during `rpmbuild`
		- see [`%{_builddir}`](#_builddir)
	- `cd %{builddir}`
- uncompress the archive
  - internally uses [`%{uncompress:â€¦}`](#uncompress)
- `cd %{?buildsubdir}`

#### `%autopatch â€¦` ğŸ”¢ [#autopatch]

Apply patches.

Wrapper around `%__apply_patch`. No, this does not wrap around [`%patch`](#patch)!

Parameterized as `%autopatch(vqp:m:M:)`:
- `-v`: verbose
- `-q`: donâ€™t warn if there are no matching patches
- `-p n`: number of top-level path components to strip (default 0) \
	For example, if the patch uses the path `a/b/hello.txt`,
	passing in `-p1` will strip it to `b/hello.txt`,
	and passing in `-p2` will strip it to just `hello.txt`.
- `-m n`: apply patches starting from `n` (default 0)
- `-M n`: apply patches up to `n` (default to the last patch number for `Patch:`)

Examples:
- `%autopatch -m 100`: apply patches with number &gt;= 100
- `%autopatch -M 400`: apply patches with number &lt;= 400
- `%autopatch -m 80 -M 99`: apply patches 80 to 99 inclusive
- `%autopatch 1 4 6`: apply patches 1, 4 and 6

Reference: https://rpm-software-management.github.io/rpm/manual/autosetup.html#autopatch

#### `%patch â€¦` ğŸ”¢ğŸš¸ [#patch]

Apply a patch.

<Callout type="warning">
  Only available in a spec file.
</Callout>

We recommend [`%autopatch`](#autopatch) over this.

Parameterized as `%patch(b:p:P:REz:)`.

### Paths

This list is NOT exhaustive. Some macros are not built-in. If your
machine does not come with them, try `dnf install 'rpm_macro(macro_name)'{:sh}`.

```
/
â”£â•¸boot
â”ƒ â”—â•¸efi
â”ƒ   â”—â•¸EFI             â‡’ %{efi_esp_efi}
â”ƒ     â”—â•¸fedora        â‡’ %{efi_esp_dir}
â”£â•¸etc                 â‡’ %{_sysconfdir}
â”ƒ â”£â•¸fonts             â‡’ %{_fontconfig_masterdir}
â”ƒ â”ƒ â”—â•¸conf.d          â‡’ %{_fontconfig_confdir}
â”ƒ â”£â•¸java              â‡’ %{_javaconfdir}
â”ƒ â”£â•¸jvm-common        â‡’ %{_jvmcommonsysconfdir}
â”ƒ â”£â•¸jvm               â‡’ %{_jvmsysconfdir}
â”ƒ â”£â•¸pam.d             â‡’ %{_pam_confdir}
â”ƒ â”£â•¸rc.d
â”ƒ â”ƒ â”—â•¸init.d          â‡’ %{_initddir} %{_initrddir}
â”ƒ â”—â•¸security          â‡’ %{_pam_secconfdir}
â”£â•¸run                 â‡’ %{_rundir} %{_runstatedir}
â”£â•¸usr                 â‡’ %{_usr} %{_prefix} %{_exec_prefix}
â”ƒ â”£â•¸bin               â‡’ %{_bindir} (%{fedora}>=42: %{_sbindir})
â”ƒ â”£â•¸sbin              â‡’ %{_sbindir} (older fedora versions)
â”ƒ â”£â•¸src               â‡’ %{_usrsrc}
â”ƒ â”£â•¸tmp               â‡’ %{_tmppath}
â”ƒ â”£â•¸include           â‡’ %{_includedir} %{_oldincludedir}
â”ƒ â”ƒ â”—â•¸d               â‡’ %{_d_includedir}
â”ƒ â”£â•¸lib64             â‡’ %{_libdir} %{_pam_libdir} %{_usr}/%{_lib}
â”ƒ â”ƒ â”£â•¸gfortran
â”ƒ â”ƒ â”ƒ â”—â•¸modules       â‡’ %{_fmoddir}
â”ƒ â”ƒ â”£â•¸lua
â”ƒ â”ƒ â”ƒ â”—â•¸%{lua_version} â‡’ %{lua_libdir}
â”ƒ â”ƒ â”£â•¸ocaml           â‡’ %{ocamldir}
â”ƒ â”ƒ â”—â•¸security        â‡’ %{_pam_moduledir}
â”ƒ â”£â•¸lib               â‡’ %{_libdir} ONLY ON `noarch` OR 32-BIT PLATFORMS
â”ƒ â”ƒ â”£â•¸binfmt.d        â‡’ %{_binfmtdir}
â”ƒ â”ƒ â”£â•¸clang
â”ƒ â”ƒ â”ƒ â”—â•¸%{clang_major_version} â‡’ %{clang_resource_dir}
â”ƒ â”ƒ â”£â•¸environment.d   â‡’ %{_environmentdir}
â”ƒ â”ƒ â”£â•¸java            â‡’ %{_jnidir}
â”ƒ â”ƒ â”£â•¸jvm             â‡’ %{_jvmdir} %{_jvmlibdir}
â”ƒ â”ƒ â”£â•¸jvm-common      â‡’ %{_jvmcommonlibdir}
â”ƒ â”ƒ â”£â•¸jvm-private     â‡’ %{_jvmprivdir}
â”ƒ â”ƒ â”£â•¸kernel
â”ƒ â”ƒ â”ƒ â”—â•¸install.d     â‡’ %{_kernel_install_dir}
â”ƒ â”ƒ â”£â•¸modprobe.d      â‡’ %{_modprobedir}
â”ƒ â”ƒ â”£â•¸modules-load.d  â‡’ %{_modulesloaddir}
â”ƒ â”ƒ â”£â•¸mono            â‡’ %{_monodir}
â”ƒ â”ƒ â”ƒ â”—â•¸gac           â‡’ %{_monogacdir}
â”ƒ â”ƒ â”£â•¸rpm             â‡’ %{_rpmconfigdir} %{getconfdir}
â”ƒ â”ƒ â”ƒ â”£â•¸fileattrs     â‡’ %{_fileattrsdir}
â”ƒ â”ƒ â”ƒ â”£â•¸lua           â‡’ %{_rpmluadir}
â”ƒ â”ƒ â”ƒ â”—â•¸macros.d      â‡’ %{_rpmmacrodir} %{rpmmacrodir}
â”ƒ â”ƒ â”£â•¸sysctl.d        â‡’ %{_sysctldir}
â”ƒ â”ƒ â”£â•¸sysusers.d      â‡’ %{_sysusersdir}
â”ƒ â”ƒ â”£â•¸swidtag
â”ƒ â”ƒ â”ƒ â”—â•¸fedoraproject.org â‡’ %{_swidtagdir}
â”ƒ â”ƒ â”£â•¸systemd         â‡’ %{_systemd_util_dir}
â”ƒ â”ƒ â”ƒ â”£â•¸catalog       â‡’ %{_journalcatalogdir}
â”ƒ â”ƒ â”ƒ â”£â•¸user          â‡’ %{_userunitdir}
â”ƒ â”ƒ â”ƒ â”£â•¸user-environment-generators   â‡’ %{_systemd_user_env_generator_dir}
â”ƒ â”ƒ â”ƒ â”£â•¸user-preset   â‡’ %{_userpresetdir}
â”ƒ â”ƒ â”ƒ â”£â•¸user-generators   â‡’ %{_systemdusergeneratordir}
â”ƒ â”ƒ â”ƒ â”£â•¸system        â‡’ %{_unitdir}
â”ƒ â”ƒ â”ƒ â”£â•¸system-environment-generators â‡’ %{_systemd_system_env_generator_dir}
â”ƒ â”ƒ â”ƒ â”£â•¸system-generators â‡’ %{_systemdgeneratordir}
â”ƒ â”ƒ â”ƒ â”—â•¸system-preset â‡’ %{_presetdir}
â”ƒ â”ƒ â”£â•¸tmpfiles.d      â‡’ %{_tmpfilesdir}
â”ƒ â”ƒ â”—â•¸udev
â”ƒ â”ƒ   â”£â•¸hwdb.d        â‡’ %{_udevhwdbdir}
â”ƒ â”ƒ   â”—â•¸rules.d       â‡’ %{_udevrulesdir}
â”ƒ â”£â•¸libexec           â‡’ %{_libexecdir}
â”ƒ â”ƒ â”—â•¸perl5-tests     â‡’ %{perl_testdir}
â”ƒ â”—â•¸share             â‡’ %{_datadir} %{_datarootdir}
â”ƒ   â”£â•¸bash-completion
â”ƒ   â”ƒ â”—â•¸completions   â‡’ %{bash_completions_dir}
â”ƒ   â”£â•¸cargo
â”ƒ   â”ƒ â”—â•¸registry      â‡’ %{cargo_registry}
â”ƒ   â”ƒ   â”—â•¸%{crate}-%{version_no_tilde} â‡’ %{crate_instdir}
â”ƒ   â”£â•¸color           â‡’ %{_colordir} %{_syscolordir}
â”ƒ   â”ƒ â”£â•¸cmms          â‡’ %{_cmmscolordir}
â”ƒ   â”ƒ â”£â•¸icc           â‡’ %{_icccolordir}
â”ƒ   â”ƒ â”—â•¸settings      â‡’ %{_settingscolordir}
â”ƒ   â”£â•¸doc             â‡’ %{_docdir} %{_defaultdocdir}
â”ƒ   â”ƒ â”—â•¸%{name}      â‡’ %{_pkgdocdir}
â”ƒ   â”£â•¸elvish
â”ƒ   â”ƒ â”—â•¸lib
â”ƒ   â”ƒ   â”—â•¸completions â‡’ %{elvish_completions_dir}
â”ƒ   â”£â•¸fish
â”ƒ   â”ƒ â”—â•¸vendor_completions.d â‡’ %{fish_completions_dir}
â”ƒ   â”£â•¸fonts           â‡’ %{_fontbasedir}
â”ƒ   â”£â•¸fontconfig
â”ƒ   â”ƒ â”—â•¸conf.avail    â‡’ %{_fontconfig_templatedir}
â”ƒ   â”£â•¸icons           â‡’ %{_iconsdir}
â”ƒ   â”£â•¸info            â‡’ %{_infodir}
â”ƒ   â”£â•¸ivy-xmls        â‡’ %{_ivyxmldir}
â”ƒ   â”£â•¸java            â‡’ %{_javadir}
â”ƒ   â”£â•¸javadoc         â‡’ %{_javadocdir}
â”ƒ   â”£â•¸jvm             â‡’ %{_jvmdatadir}
â”ƒ   â”£â•¸jvm-common      â‡’ %{_jvmcommondatadir}
â”ƒ   â”£â•¸licenses        â‡’ %{_defaultlicensedir}
â”ƒ   â”£â•¸lua
â”ƒ   â”ƒ â”—â•¸%{lua_version} â‡’ %{lua_pkgdir}
â”ƒ   â”£â•¸man             â‡’ %{_mandir}
â”ƒ   â”£â•¸maven-poms      â‡’ %{_mavenpomdir}
â”ƒ   â”£â•¸metainfo        â‡’ %{_metainfodir}
â”ƒ   â”£â•¸pam.d           â‡’ %{_pam_vendordir}
â”ƒ   â”£â•¸pkgconfig
â”ƒ   â”ƒ â”—â•¸personality.d â‡’ %{pkgconfig_personalitydir}
â”ƒ   â”£â•¸systemtap
â”ƒ   â”ƒ â”—â•¸tapset        â‡’ %{_systemtap_tapsetdir}
â”ƒ   â”£â•¸user-tmpfiles.d â‡’ %{_user_tmpfilesdir}
â”ƒ   â”£â•¸zsh
â”ƒ   â”ƒ â”—â•¸site-functions â‡’ %{zsh_completions_dir}
â”ƒ   â”—â•¸%{python_wheel_pkg_prefix}-wheels â‡’ %{python_wheel_dir}
â”—â•¸var                 â‡’ %{_var} %{_localstatedir}
  â”—â•¸lib               â‡’ %{_sharedstatedir}
```
```
/home/mado/rpmbuild   â‡’ %{_topdir}
â”£â•¸BUILD               â‡’ %{_builddir}
â”ƒ â”—â•¸%{buildsubdir}
â”ƒ   â”£â•¸.pyproject-builddir%{_pyproject_files_pkgversion} â‡’ %{_pyproject_builddir}
â”ƒ   â”—â•¸pyproject-wheeldir%{_pyproject_files_pkgversion}  â‡’ %{_pyproject_wheeldir}
â”£â•¸RPMS                â‡’ %{_rpmdir}
â”£â•¸SOURCES             â‡’ %{_sourcedir}
â”£â•¸SPECS               â‡’ %{_specdir}
â”—â•¸SRPMS               â‡’ %{_srcrpmdir}
```

#### Common Paths ğŸ”° [#common-paths]

```
/etc                                   â‡’ %{_sysconfdir}
/run                                   â‡’ %{_rundir}
/usr                                   â‡’ %{_usr}
/usr/bin                               â‡’ %{_bindir}
/usr/sbin                              â‡’ %{_sbindir} maybe?
/usr/src                               â‡’ %{_usrsrc}
/usr/include                           â‡’ %{_includedir}
/usr/lib64                             â‡’ %{_libdir}
/usr/lib                               â‡’ %{_libdir} if `noarch` or 32-bit platforms
/usr/lib/sysctl.d                      â‡’ %{_sysctldir}
/usr/lib/sysusers.d                    â‡’ %{_sysusersdir}
/usr/lib/systemd/user                  â‡’ %{_userunitdir}
/usr/lib/systemd/user-preset           â‡’ %{_userpresetdir}
/usr/lib/systemd/system                â‡’ %{_unitdir}
/usr/lib/systemd/system-preset         â‡’ %{_presetdir}
/usr/libexec                           â‡’ %{_libexecdir}
/usr/share                             â‡’ %{_datadir}
/usr/share/doc                         â‡’ %{_docdir}
/usr/share/icons                       â‡’ %{_iconsdir}
/usr/share/info                        â‡’ %{_infodir}
/usr/share/licenses                    â‡’ %{_defaultlicensedir}
/usr/share/man                         â‡’ %{_mandir}
/usr/share/metainfo                    â‡’ %{_metainfodir}
/var                                   â‡’ %{_var}
/var/lib                               â‡’ %{_sharedstatedir}

/usr/share/bash-completion/completions â‡’ %{bash_completions_dir}
/usr/share/elvish/lib/completions      â‡’ %{elvish_completions_dir} (Terra only)
/usr/share/fish/vendor_completions.d   â‡’ %{fish_completions_dir}
/usr/share/zsh/site-functions          â‡’ %{zsh_completions_dir}
```

### In `%install`

#### `%buildroot` ğŸ”° [#buildroot]

<Callout type="warning">
  Only available in a spec file.
</Callout>

Path to a specific directory where files, that get packaged into the final RPM, should live.
This is the same as `$pkgdir` in Arch Linux PKGBUILDs.

#### `%find_lang` ğŸ”° [#find_lang]

From `/usr/lib/rpm/find-lang.sh`:
> ```
> automagically generate list of language specific files
> for inclusion in an rpm spec file.
> This does assume that the *.mo files are under .../locale/...
> ```

Expand to exactly `/usr/lib/rpm/find-lang.sh %{buildroot}`.
Used with the `-f` flag for `%files`.
Useful for packaging `/usr/share/locale/*/LC_MESSAGES/%{app_id}.mo` files.

```
$ /usr/lib/rpm/find-lang.sh

Usage: /usr/lib/rpm/find-lang.sh TOP_DIR PACKAGE_NAME [prefix]

where TOP_DIR is
the top of the tree containing the files to be processed--should be
$RPM_BUILD_ROOT usually. TOP_DIR gets sed'd out of the output list.
PACKAGE_NAME is the %{name} of the package. This should also be
the basename of the .mo files.  the output is written to
PACKAGE_NAME.lang unless $3 is given in which case output is written
to $3.
Additional options:
  --with-gnome          find GNOME help files
  --with-mate           find MATE help files
  --with-kde            find KDE help files
  --with-qt             find Qt translation files
  --with-html           find HTML files
  --with-man            find localized man pages
  --all-name            match all package/domain names
  --without-mo          do not find locale files
  --generate-subpackages move language files in one sub package per language
```

```rpmspec filename="example.spec" {7,9} /%find_lang/ /-f mugshot.lang/
# https://github.com/terrapkg/packages/blob/2635988e63fa5a05bd2c42d34c893d9e2bb13580/anda/apps/mugshot/mugshot.spec#L41-L46
%install
%pyproject_install
%pyproject_save_files -L 'mugshot*'
install -Dm644 data/glib-2.0/schemas/%{lower:%app}.gschema.xml %buildroot%_datadir/glib-2.0/schemas/

%find_lang mugshot

%files -f %{pyproject_files} -f mugshot.lang
%doc README.md NEWS
â€¦
```

#### `%fdupes â€¦` ğŸ”¢ [#fdupes]

Hard-link (or symlink) files to save space.

Parameterized as `%fdupes(s)`:
- `-s`: use symlinks instead of hard links

Take in exactly 1 argument: a glob path that lists out files to be deduplicated.

```rpmspec filename="example.spec" {2,12}
# https://github.com/terrapkg/packages/blob/2635988e63fa5a05bd2c42d34c893d9e2bb13580/anda/themes/fluent-theme/fluent-theme.spec#L31
BuildRequires:  fdupes
# or BuildRequires:  rpm_macro(fdupes)

â€¦

%install
mkdir -p %{buildroot}%{_datadir}/themes
./install.sh -i simple -t all -d %{buildroot}%{_datadir}/themes
./install.sh -i simple -t all --tweaks round float -d %{buildroot}%{_datadir}/themes

%fdupes %buildroot%_datadir

%files
%license COPYING
%doc README.md

%{_datadir}/themes/Fluent*/
```

<Callout>
	Use [`%{quote:â€¦}{:rpmspec}`](#quote) to feed in multiple paths:
	```rpmspec
	%fdupes %{quote:%buildroot%_datadir %buildroot%_sysconfdir}
	```
</Callout>

## Per Language

If your language / buildsystem is not listed here, go to
https://docs.fedoraproject.org/en-US/packaging-guidelines/
and find them on the navigation rail on the left.

### C and C++

#### `%configure` [#configure]

Expand to `./configure` with the correct flags and arguments.
If you need to execute `./configure`, in most cases you should use this macro instead.

In some cases where `./configure` is not directly available, you may need to run
`autoreconf -fi` or `-fiv`.

#### `%make_build` ğŸ”° [#make_build]

â‡’ `%__make -O -j${RPM_BUILD_NCPUS} V=1 VERBOSE=1{:sh}`,
where `%{__make}` â‡’ `/usr/bin/make`.
Further arguments to `make` can be attached.

#### `%make_install` ğŸ”° [#make_install]

â‡’ `%__make install DESTDIR=%?buildroot INSTALL="%__install -p"{:sh}`.

#### `%makeinstall` ğŸš¸ [#makeinstall]

Deprecated. Use [`%make_install`](#make_install) instead.

#### `%cmake` ğŸ”° [#cmake]

Expand to `%{__cmake}` (â‡’ `/usr/bin/cmake`) with the correct flags,
such as `-B "%__cmake_builddir"{:sh}` (â‡’ `-B "redhat-linux-build"{:sh}`).

#### `%cmake_build` ğŸ”° [#cmake_build]

â‡’ `%__cmake --build "%__cmake_builddir" %?_smp_mflags --verbose{:sh}`.

#### `%cmake_install` ğŸ”° [#cmake_install]

â‡’ `DESTDIR="%buildroot" %__cmake --install "%__cmake_builddir"{:sh}`.

#### `%meson` ğŸ”° [#meson]

â‰ˆ `%__meson setup{:sh}` with correct flags.

#### `%meson_build` ğŸ”° [#meson_build]

â‡’ `%__meson compile -C "%_vpath_builddir" -j %_smp_build_ncpus %{?__meson_verbose:--verbose}{:sh}`

â‡’ `/usr/bin/meson compile -C redhat-linux-build -j 20 --verbose{:sh}` (on my machine).

#### `%meson_install` ğŸ”° [#meson_install]

â‡’ `DESTDIR=%buildroot %__meson install -C %_vpath_builddir --no-rebuild{:sh}`.
Used in `%install{:rpmspec}`.

#### `%meson_test` ğŸ”° [#meson_test]

â‡’ `%__meson test -C %_vpath_builddir --no-rebuild %{!?__meson_verbose:--quiet}{:sh}`.
Used in `%check{:rpmspec}`.

#### `%ninja_build` [#ninja_build]

â‡’ `%__ninja %__ninja_common_opts{:sh}`

â‡’ `%__ninja -v -j${RPM_BUILD_NCPUS}{:sh}`.

#### `%ninja_install` [#ninja_install]

â‡’ `DESTDIR=%buildroot %__ninja install %__ninja_common_opts{:sh}`.

#### `%ninja_test` [#ninja_test]

â‡’ `%__ninja test %__ninja_common_opts{:sh}`.

#### `%build_cflags` ğŸ·ï¸ [#build_cflags]

Flags to be passed to the C compiler.

â‡’ `%{__build_flags_lang_c} %{?_distro_extra_cflags}`

#### `%_distro_extra_cflags` ğŸ·ï¸ [#_distro_extra_cflags]

For example, if the compiler is emitting errors that could be disabled with some
`-Wno-â€¦` flags, you can define this macro with extra flags.

This macro is not defined by default on Fedora.

#### `%build_cxxflags` ğŸ·ï¸ [#build_cxxflags]

Flags to be passed to the C++ compiler.

â‡’ `%{__build_flags_lang_cxx} %{?_distro_extra_cxxflags}`

#### `%_distro_extra_cxxflags` ğŸ·ï¸ [#_distro_extra_cxxflags]

For example, if the compiler is emitting errors that could be disabled with some
`-Wno-â€¦` flags, you can define this macro with extra flags.

This macro is not defined by default on Fedora.

### D

#### `%ldc_arches` [#ldc_arches]

#### `%_d_optflags` [#_d_optflags]

### Java

https://docs.fedoraproject.org/en-US/java-packaging-howto/

### Nim

This section is only applicable to Terra (because Fedora does not ship Nim).

#### `%nim_prep` [#nim_prep]

Set `mold` as the linker and run `nimble setup -y`.

#### `%nim_build` [#nim_build]

Same as [`%nim_c`](#nim_c).

#### `%nim_c` [#nim_c]

â‡’ `nim c -d:release -t:"%nim_tflags" -l:"%nim_lflags"{:sh}`.

### Python

https://docs.fedoraproject.org/en-US/packaging-guidelines/Python/

### Rust

https://docs.fedoraproject.org/en-US/packaging-guidelines/Rust/

#### `%rustflags_debuginfo` ğŸ·ï¸ [#rustflags_debuginfo]

If `gdb` crashes in `find-debuginfo`, you might want to lower the value to `1` or even `0`.

The default value is `2`.

```rpmspec filename="example.spec" {11}
https://github.com/terrapkg/packages/blob/2df55dad60a58ecf5f8fbe962f877f2834bdfa25/anda/devs/zed/nightly/zed-nightly.spec#L14

%bcond_with check

# Exclude input files from mangling
%global __brp_mangle_shebangs_exclude_from ^/usr/src/.*$

%global crate zed
%global app_id dev.zed.Zed-Nightly

%global rustflags_debuginfo 0
```

[expression]: ./expr
