---
title: Macro Syntax
description: "Documentations for how macro expansion works."
# vi: noet ci pi sts=0 sw=2 ts=2
---

import { Callout } from "nextra/components";
import { Split } from "../../components/split";

# Macro Syntax

RPM is a very powerful packaging system. One very reason is its macro support.

A macro is a piece of "shorthand" identifier that expands to some content. Arguments can be fed
into macros to obtain different desired results. It is similar to "functions" or "procedures"
in programming terms.

Macros in RPM are denoted by a `%` (U+0025 PERCENT SIGN) prefix, and can be further
split into 3 separate categories:

1. `%{rpm_macro}`: normal RPM macros. When someone says "macro", they probably are referring
   to this.
2. `%(echo "hi" | sed 's/hi/hello/')`: shell macros that expands to the output of the commands.
3. `%[v"1.2.3~1" < v"1.2.3"]`: RPM [expression](./expr).

[For the first type, here is a list of the documented macros](./macros).

The second type is pretty straightforward: by writing shell expressions wrapped around `%(…)`,
it expands to the output (stdout).

[The third type is documented here](./expr).

The `%` character can be escaped. If you want to say `echo %hello` without expanding the `%hello`
macro, you are looking for `echo %%hello`.

## Macro Name

The macro name (i.e. the identifier of the macro) must match the regex
```ts
/^(?!_$)[a-zA-Z_][a-zA-Z0-9_]*$/
```

There are exceptions to this rule, but as far as macros defined by the users (packagers),
this MUST be followed. Of course, this document will mention all exceptions.

The RPM manual claims that the name "must be at least 3 characters in length"[^1]
but as far as concerned that is the biggest lie in the century:
```sh
$ rpm -D 'a 1' -E '%a'
1
```

## Referring to Macros

Let's look at an example:
```rpmspec
%{_bindir}
```

Normally this expands to `/usr/bin`. In many cases, you don't actually need the `{}`:

```rpmspec
%_bindir
```

This also expands to `/usr/bin`. When dealing with normal unparameterized macros,
unless the next character matches the regex `[a-zA-Z0-9_]`, i.e. the next character is
a valid character in a macro identifier, the macro may be written with or without `{}`.
Otherwise, `{}` must be used to avoid ambiguity.

## Defining Macros

When running `rpm --eval '…'{:sh}` or `rpm -E '…'{:sh}`, you may want to define a macro
valid only for that command. In that case, use `--define 'macro_name macro_body'`, or
`-D 'macro_name macro_body'`.

If you are writing a macro definition in a spec file, use one of:
```rpmspec
%define macro_name    macro_body
%global macro_name(-) macro_body
```

See documentations for [`%define`](./macros#define) and [`%global`](./macros#global).

If you are writing a macro definition in `%_rpmmacrodir` (⇒ `/usr/lib/rpm/macros.d`):

```rpmspec
%macro_name    macro_body
%macro_name(-) macro_body
```

### Escaping

When the macro body spans multiple lines, an unescaped `\` may be needed at the end of each
line except the last line of the macro body. To write the character `\`, use `\\`. 
Since the same shell command when spanned multiple lines requires the same mechanism,
in many cases you will need to use `\\\`:

<Split>
	<Split.Left>
		```rpmspec filename="/usr/lib/rpm/macros.d/macros.example"
		%say_hello echo \\\
		Hello, World! && \\\
		echo This is from the %%say_hello macro! \
		echo This is a second line of shell command. && \\\
		echo Pretty cool.
		```
	</Split.Left>
	<Split.Right>
		```sh
		$ rpm -E '%say_hello'
		echo \
		Hello, World! && \
		echo This is from the %say_hello macro!
		echo This is a second line of shell command. && \
		echo Pretty cool.
		```
	</Split.Right>
</Split>

<Split>
	<Split.Left>
		```rpmspec filename="/usr/lib/rpm/macros.d/macros.example"
		%say_hello %{lua:
			print("echo 'Hello, ")
			-- you also need to escape backslash for the new line character in lua strings
			print("World!'\\n")
			-- macros in lua are not expanded by default, so %% is not needed here
			print("echo 'from %say_hello using %{lua:…}!'")
		}
		```
	</Split.Left>
	<Split.Right>
		```sh
		$ rpm -E '%say_hello'
		echo \
		Hello, World! && \
		echo This is from the %say_hello macro!
		echo This is a second line of shell command. && \
		echo Pretty cool.
		```
	</Split.Right>
</Split>

But that does not mean `\` is needed when dealing with a multi-line macro body.

For definition files in `/usr/lib/rpm/macros.d/`, strictly speaking, RPM assumes
a blank line separates different macro definitions. Therefore, no macro body may be written
with any blank lines present. Blank lines must end with a `\`:

```rpmspec filename="/usr/lib/rpm/macros.d/macros.rust-srpm" showLineNumbers {14,18,23}
# rust_arches: list of architectures where building Rust is supported
#
# Since RPM itself now depends on Rust code (via its GPG backend, rpm-sequoia),
# this list will probably always be a superset of all architectures that are
# supported by Fedora, which is why it is no longer required to set
# "ExclusiveArch: rust_arches" for Rust packages in Fedora.
%rust_arches x86_64 %{ix86} armv7hl aarch64 ppc64 ppc64le riscv64 s390x

# version_no_tilde: lua macro for reconstructing the original crate version
#       from the RPM version (i.e. replace any "~" characters with "-")
%version_no_tilde() %{lua:
    local sep = rpm.expand('%1')
    local ver = rpm.expand('%2')
\
    if sep == '%1' then
        sep = '-'
    end
\
    if ver == '%2' then
        ver = rpm.expand('%version')
    end
    ver = ver:gsub('~', sep)
\
    print(ver)
}
…
```

<Callout type="info">
  Mado: I don't know the actual complete rule for this to be honest (which is why `rpmspec-rs`
  is so broken right now) but generally speaking if your macro body does not start with `%{lua:`,
  you'll need `\` at the end of each line.
</Callout>

### Comments

In [`%{lua:…}`](./macros#lua), comments must start with `-- ` (with the space).
`# …` is not accepted. Note that `#` is a special operator in Lua for obtaining the length of an
array or a string.

Otherwise, `#` is fine outside of Lua code.

See also: [`%{dnl:…}`](./macros#dnl)

## Conditionally Expanded Macros

## Parameterized Macros

[^1]: https://github.com/rpm-software-management/rpm/blob/master/docs/manual/macros.md#defining-a-macro, permalink: https://github.com/rpm-software-management/rpm/blob/1ca57c6cfe264a211a6a93bf4fe68b463bd4861a/docs/manual/macros.md#defining-a-macro
